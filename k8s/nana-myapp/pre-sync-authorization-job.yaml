apiVersion: batch/v1
kind: Job
metadata:
  generateName: pre-sync-authorization-
  namespace: myapp
  annotations:
    argocd.argoproj.io/hook: PreSync
    argocd.argoproj.io/hook-delete-policy: ""
    argocd.argoproj.io/hook-failure-policy: Fail
    argocd.argoproj.io/sync-wave: "0"
spec:
  backoffLimit: 1
  template:
    spec:
      restartPolicy: Never
      terminationGracePeriodSeconds: 300
      containers:
        - name: authorize
          image: yanivmendiuk/pre-sync-job:1.0
          env:
            - name: ARGOCD_APP_NAME
              valueFrom:
                configMapKeyRef:
                  name: pre-sync-config
                  key: ARGOCD_APP_NAME
            - name: WEBHOOK_HOST
              valueFrom:
                configMapKeyRef:
                  name: pre-sync-config
                  key: WEBHOOK_HOST
            - name: WEBHOOK_PORT
              valueFrom:
                configMapKeyRef:
                  name: pre-sync-config
                  key: WEBHOOK_PORT
          command:
            - sh
            - -c
            - |
              echo "---- ENVIRONMENT VARIABLES ----"
              env
              echo "---- STARTING WEBHOOK REQUEST ----"

              APP_NAME="${ARGOCD_APP_NAME}"
              echo "App name: $APP_NAME"

              REPO_URL=$(argocd app get "$APP_NAME" -o json | jq -r '.spec.source.repoURL')
              echo "Repo URL: $REPO_URL"

              OWNER=$(echo "$REPO_URL" | sed -E 's#https://github.com/([^/]+)/([^/]+)(\.git)?#\1#')
              REPO=$(echo "$REPO_URL" | sed -E 's#https://github.com/([^/]+)/([^/]+)(\.git)?#\2#')
              REPO=${REPO%.git}

              echo "Owner: $OWNER"
              echo "Repo: $REPO"

              COMMIT_INFO=$(curl -s "https://api.github.com/repos/$OWNER/$REPO/commits/HEAD")
              LATEST_COMMIT=$(echo "$COMMIT_INFO" | jq -r '.sha')
              AUTHOR_EMAIL=$(echo "$COMMIT_INFO" | jq -r '.commit.author.email')

              echo "Latest commit SHA: $LATEST_COMMIT"
              echo "Author email: $AUTHOR_EMAIL"

              RESPONSE=$(curl -v -s -w "%{http_code}" -o /tmp/response.txt \
                -X POST "http://${WEBHOOK_HOST}:${WEBHOOK_PORT}/authorize?path=${APP_NAME}" \
                -H "Content-Type: application/json" \
                -H "ARGOCD_APP_SOURCE_USER: ${ARGOCD_APP_SOURCE_USER:-unknown}" \
                -d "{\"repoURL\":\"$REPO_URL\",\"latestCommit\":\"$LATEST_COMMIT\",\"authorEmail\":\"$AUTHOR_EMAIL\"}")

              HTTP_CODE=${RESPONSE:(-3)}
              BODY=$(cat /tmp/response.txt)

              echo "HTTP_CODE: $HTTP_CODE"
              echo "BODY: $BODY"
